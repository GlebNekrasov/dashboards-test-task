import{d as M,r as h,c as g,w as P,a as b,s as S,b as k,e as f,u as a,i as y,B as L,f as z,o as x,g as B,_ as T,h as A,j as F}from"./index-CJeviEfv.js";import{r as O,M as E,a as D,D as R,b as N,T as U}from"./index-BSJIu_te.js";import{S as q}from"./SingleLinePeriodChart-BWy2c8Gb.js";function K(_){return O({url:"/incomes",method:"get",params:_})}const $=M("incomes",()=>{const _=h(!1),c=h(""),s=h(""),n=h(0),d=E,m=g(()=>n.value>=d),e=h([]),p=g(()=>e.value.filter(t=>!(l.value.length>0&&!l.value.includes(t.supplier_article)||o.value.length>0&&!o.value.includes(t.warehouse_name)))),l=h([]),o=h([]),i=g(()=>{const t=e.value.filter(u=>!(l.value.length>0&&!l.value.includes(u.supplier_article)));return[...new Set(t.map(u=>u.warehouse_name))]}),I=g(()=>{const t=e.value.filter(u=>!(o.value.length>0&&!o.value.includes(u.warehouse_name)));return[...new Set(t.map(u=>u.supplier_article))]});function v(){e.value=[],l.value=[],o.value=[],n.value=0}async function C(t=1,u=500){const w=await K({dateFrom:c.value,dateTo:s.value,page:t,limit:u});return{data:w.data,meta:w.meta}}async function r(){let t=!1,u=1;for(e.value=[],n.value=0;!t&&e.value.length<d;)try{_.value=!0;const w=await C(u);n.value=w.meta.total,e.value.push(...w.data),u===w.meta.last_page&&(t=!0),u++}catch{D.error({message:"Не получилось загрузить данные о доходах"}),v()}finally{_.value=!1}n.value>=d&&D.warning({message:`Превышен лимит ${d} по количеству записей в одном запросе.`})}return P(()=>[c.value,s.value],()=>{c.value&&s.value?r():v()}),{dateFrom:c,dateTo:s,filteredIncomesData:p,foundRecordsCount:n,incomesData:e,isLoading:_,isMaxRecordCountExceeded:m,maxRecordsCount:d,selectedSupplierArticles:l,selectedWarehouseNames:o,supplierArticleOptions:I,warehouseNameOptions:i,getIncomesData:r}}),V={class:"incomes-filters"},W=b({__name:"IncomesFilters",setup(_){const c=$(),{dateFrom:s,dateTo:n,incomesData:d,selectedSupplierArticles:m,selectedWarehouseNames:e,supplierArticleOptions:p,warehouseNameOptions:l,isLoading:o}=S(c),i=g(()=>d.value.length===0||o.value),I=g(()=>s.value!==""||n.value!==""||m.value.length>0||e.value.length>0);function v(){s.value="",n.value="",m.value=[],e.value=[]}return(C,r)=>(x(),k("div",V,[f(R,{"date-text":a(s),"onUpdate:dateText":r[0]||(r[0]=t=>y(s)?s.value=t:null),disabled:a(o),title:"Дата с"},null,8,["date-text","disabled"]),f(R,{"date-text":a(n),"onUpdate:dateText":r[1]||(r[1]=t=>y(n)?n.value=t:null),disabled:a(o),title:"Дата до"},null,8,["date-text","disabled"]),f(N,{value:a(m),"onUpdate:value":r[2]||(r[2]=t=>y(m)?m.value=t:null),disabled:i.value,options:a(p),title:"Артикул поставщика",width:300},null,8,["value","disabled","options"]),f(N,{value:a(e),"onUpdate:value":r[3]||(r[3]=t=>y(e)?e.value=t:null),disabled:i.value,options:a(l),title:"Склад",width:300},null,8,["value","disabled","options"]),f(a(L),{disabled:!I.value||a(o),type:"primary",onClick:v},{default:z(()=>[...r[4]||(r[4]=[B(" Очистить фильтры ",-1)])]),_:1},8,["disabled"])]))}}),j=T(W,[["__scopeId","data-v-b709a748"]]),X={class:"incomes-table"},G=b({__name:"IncomesTable",setup(_){const c=$(),{filteredIncomesData:s,isLoading:n,isMaxRecordCountExceeded:d,foundRecordsCount:m,incomesData:e}=S(c),p=[{title:"ID дохода",dataIndex:"income_id",key:"income_id",width:100,fixed:"left"},{title:"NM ID",dataIndex:"nm_id",key:"nm_id",width:100,fixed:"left"},{title:"Дата дохода",dataIndex:"date",key:"date",width:100},{title:"Артикул поставщика",dataIndex:"supplier_article",key:"supplier_article",width:150},{title:"Размер",dataIndex:"tech_size",key:"tech_size",width:150},{title:"Штрихкод",dataIndex:"barcode",key:"barcode",width:100},{title:"Кол-во",dataIndex:"quantity",key:"quantity",width:80},{title:"Итоговая цена",dataIndex:"total_price",key:"total_price",width:100},{title:"Дата закрытия",dataIndex:"date_close",key:"date_close",width:100},{title:"Склад",dataIndex:"warehouse_name",key:"warehouse_name",width:200},{title:"Последнее изменение",dataIndex:"last_change_date",key:"last_change_date",width:100}];function l(i){return`${i.nm_id}-${i.income_id}-${i.supplier_article}-${i.warehouse_name}`}function o(i){return d.value?`Всего найдено ${m.value} строк за выбранный период, загружено ${e.value.length} строк. В таблице показано ${i} строк с учетом фильтрации.`:`Всего строк в таблице: ${i}`}return(i,I)=>(x(),k("div",X,[a(s).length>0?(x(),A(a(U),{key:0,dataSource:a(s),columns:p,loading:a(n),rowKey:v=>l(v),scroll:{x:"max-content"},size:"small",sticky:"",pagination:{pageSize:50,showTotal:v=>o(v),position:["topRight"],showSizeChanger:!1}},null,8,["dataSource","loading","rowKey","pagination"])):F("",!0)]))}}),H=T(G,[["__scopeId","data-v-336a9363"]]),J={class:"incomes-line-chart"},Q=b({__name:"IncomesLineChart",setup(_){const c=$(),{filteredIncomesData:s,dateFrom:n,dateTo:d}=S(c),m=g(()=>{const e=new Map;return s.value.forEach(p=>{const l=p.date,o=e.get(l)||0;e.set(l,o+p.quantity)}),Array.from(e.entries()).map(([p,l])=>({date:p,value:l}))});return(e,p)=>(x(),k("div",J,[a(s).length>0&&a(n)&&a(d)?(x(),A(q,{"start-date":a(n),"end-date":a(d),data:m.value,title:"Количество по датам",key:"line1"},null,8,["start-date","end-date","data"])):F("",!0)]))}}),Y={class:"incomes-page"},Z=b({__name:"IncomesPage",setup(_){return(c,s)=>(x(),k("div",Y,[f(j,{class:"incomes-page__filters"}),f(Q,{class:"incomes-page__chart"}),f(H,{class:"incomes-page__table"})]))}}),se=T(Z,[["__scopeId","data-v-6d61f807"]]);export{se as default};
