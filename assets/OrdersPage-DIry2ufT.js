import{d as M,r as m,c as g,w as P,a as k,s as O,b as I,e as h,u as a,i as y,B as L,f as z,g as B,o as x,_ as D,h as F,j as N}from"./index-CJeviEfv.js";import{r as E,M as U,a as $,D as C,b as R,T as A}from"./index-BSJIu_te.js";import{S as j}from"./SingleLinePeriodChart-BWy2c8Gb.js";function K(f){return E({url:"/orders",method:"get",params:f})}const S=M("orders",()=>{const f=m(!1),c=m(""),r=m(""),n=m(0),u=U,_=g(()=>n.value>=u),e=m([]),p=g(()=>e.value.filter(t=>!(l.value.length>0&&!l.value.includes(t.oblast)||d.value.length>0&&!d.value.includes(t.warehouse_name)))),l=m([]),d=m([]),s=g(()=>{const t=e.value.filter(i=>!(l.value.length>0&&!l.value.includes(i.oblast)));return[...new Set(t.map(i=>i.warehouse_name))]}),b=g(()=>{const t=e.value.filter(i=>!(d.value.length>0&&!d.value.includes(i.warehouse_name)));return[...new Set(t.map(i=>i.oblast))]});function v(){e.value=[],l.value=[],d.value=[],n.value=0}async function T(t=1,i=500){const w=await K({dateFrom:c.value,dateTo:r.value,page:t,limit:i});return{data:w.data,meta:w.meta}}async function o(){let t=!1,i=1;for(e.value=[],n.value=0;!t&&e.value.length<u;)try{f.value=!0;const w=await T(i);n.value=w.meta.total,e.value.push(...w.data),i===w.meta.last_page&&(t=!0),i++}catch{$.error({message:"Не получилось загрузить данные о заказах"}),v()}finally{f.value=!1}n.value>=u&&$.warning({message:`Превышен лимит ${u} по количеству записей в одном запросе.`})}return P(()=>[c.value,r.value],()=>{c.value&&r.value?o():v()}),{dateFrom:c,dateTo:r,filteredOrdersData:p,foundRecordsCount:n,isLoading:f,isMaxRecordCountExceeded:_,maxRecordsCount:u,oblastOptions:b,ordersData:e,selectedOblasts:l,selectedWarehouseNames:d,warehouseNameOptions:s,getOrdersData:o}}),V={class:"orders-filters"},W=k({__name:"OrdersFilters",setup(f){const c=S(),{dateFrom:r,dateTo:n,ordersData:u,selectedOblasts:_,selectedWarehouseNames:e,oblastOptions:p,warehouseNameOptions:l,isLoading:d}=O(c),s=g(()=>u.value.length===0||d.value),b=g(()=>r.value!==""||n.value!==""||_.value.length>0||e.value.length>0);function v(){r.value="",n.value="",_.value=[],e.value=[]}return(T,o)=>(x(),I("div",V,[h(C,{"date-text":a(r),"onUpdate:dateText":o[0]||(o[0]=t=>y(r)?r.value=t:null),disabled:a(d),title:"Дата с"},null,8,["date-text","disabled"]),h(C,{"date-text":a(n),"onUpdate:dateText":o[1]||(o[1]=t=>y(n)?n.value=t:null),disabled:a(d),title:"Дата до"},null,8,["date-text","disabled"]),h(R,{value:a(_),"onUpdate:value":o[2]||(o[2]=t=>y(_)?_.value=t:null),disabled:s.value,options:a(p),title:"Область",width:300},null,8,["value","disabled","options"]),h(R,{value:a(e),"onUpdate:value":o[3]||(o[3]=t=>y(e)?e.value=t:null),disabled:s.value,options:a(l),title:"Склад",width:300},null,8,["value","disabled","options"]),h(a(L),{disabled:!b.value||a(d),type:"primary",onClick:v},{default:z(()=>[...o[4]||(o[4]=[B(" Очистить фильтры ",-1)])]),_:1},8,["disabled"])]))}}),q=D(W,[["__scopeId","data-v-df9d653f"]]),X={class:"orders-table"},G=k({__name:"OrdersTable",setup(f){const c=S(),{filteredOrdersData:r,isLoading:n,isMaxRecordCountExceeded:u,foundRecordsCount:_,ordersData:e}=O(c),p=[{title:"Номер заказа",dataIndex:"g_number",key:"g_number",width:150,fixed:"left"},{title:"NM ID",dataIndex:"nm_id",key:"nm_id",width:100,fixed:"left"},{title:"ID дохода",dataIndex:"income_id",key:"income_id",width:100},{title:"ODID",dataIndex:"odid",key:"odid",width:100},{title:"Дата заказа",dataIndex:"date",key:"date",width:150},{title:"Артикул поставщика",dataIndex:"supplier_article",key:"supplier_article",width:150},{title:"Размер",dataIndex:"tech_size",key:"tech_size",width:150},{title:"Штрихкод",dataIndex:"barcode",key:"barcode",width:100},{title:"Итоговая цена",dataIndex:"total_price",key:"total_price",width:100,customRender:({value:s})=>s?parseFloat(s).toFixed(2):""},{title:"Скидка %",dataIndex:"discount_percent",key:"discount_percent",width:80},{title:"Склад",dataIndex:"warehouse_name",key:"warehouse_name",width:200},{title:"Область",dataIndex:"oblast",key:"oblast",width:250},{title:"Бренд",dataIndex:"brand",key:"brand",width:150},{title:"Предмет",dataIndex:"subject",key:"subject",width:150},{title:"Категория",dataIndex:"category",key:"category",width:150},{title:"Отменен",dataIndex:"is_cancel",key:"is_cancel",width:80,customRender:({value:s})=>s?"Да":"Нет"},{title:"Дата отмены",dataIndex:"cancel_dt",key:"cancel_dt",width:100},{title:"Последнее изменение",dataIndex:"last_change_date",key:"last_change_date",width:100}];function l(s){return`${s.g_number}-${s.nm_id}-${s.income_id}-${s.odid}`}function d(s){return u.value?`Всего найдено ${_.value} строк за выбранный период, загружено ${e.value.length} строк. В таблице показано ${s} строк с учетом фильтрации.`:`Всего строк в таблице: ${s}`}return(s,b)=>(x(),I("div",X,[a(r).length>0?(x(),F(a(A),{key:0,dataSource:a(r),columns:p,loading:a(n),rowKey:v=>l(v),scroll:{x:"max-content"},size:"small",sticky:"",pagination:{pageSize:50,showTotal:v=>d(v),position:["topRight"],showSizeChanger:!1}},null,8,["dataSource","loading","rowKey","pagination"])):N("",!0)]))}}),H=D(G,[["__scopeId","data-v-d418ff4f"]]),J={class:"orders-line-chart"},Q=k({__name:"OrdersLineChart",setup(f){const c=S(),{filteredOrdersData:r,dateFrom:n,dateTo:u}=O(c),_=g(()=>{const e=new Map;return r.value.forEach(p=>{const l=p.date.split(" ")[0],d=e.get(l)||0;e.set(l,d+parseFloat(p.total_price))}),Array.from(e.entries()).map(([p,l])=>({date:p,value:l}))});return(e,p)=>(x(),I("div",J,[a(r).length>0&&a(n)&&a(u)?(x(),F(j,{"start-date":a(n),"end-date":a(u),data:_.value,title:"Сумма заказов по датам",key:"line1"},null,8,["start-date","end-date","data"])):N("",!0)]))}}),Y={class:"orders-page"},Z=k({__name:"OrdersPage",setup(f){return(c,r)=>(x(),I("div",Y,[h(q,{class:"orders-page__filters"}),h(Q,{class:"orders-page__chart"}),h(H,{class:"orders-page__table"})]))}}),se=D(Z,[["__scopeId","data-v-fca53e72"]]);export{se as default};
