import{d as P,r as g,c as v,w as L,a as I,s as S,b,e as f,u as s,i as k,B as O,f as B,g as E,o as w,_ as R,h as z,j as M}from"./index-CJeviEfv.js";import{r as U,M as $,a as T,D as C,b as N,T as A}from"./index-BSJIu_te.js";import{S as j}from"./SingleLinePeriodChart-BWy2c8Gb.js";function K(m){return U({url:"/sales",method:"get",params:m})}const D=P("sales",()=>{const m=g(!1),u=g(""),n=g(""),l=g(0),c=$,_=v(()=>l.value>=$),t=g([]),p=v(()=>t.value.filter(a=>!(i.value.length>0&&!i.value.includes(a.warehouse_name)||d.value.length>0&&!d.value.includes(a.region_name)))),i=g([]),d=g([]),e=v(()=>{const a=t.value.filter(r=>!(d.value.length>0&&!d.value.includes(r.region_name)));return[...new Set(a.map(r=>r.warehouse_name))]}),y=v(()=>{const a=t.value.filter(r=>!(i.value.length>0&&!i.value.includes(r.warehouse_name)));return[...new Set(a.map(r=>r.region_name))]});function h(){t.value=[],i.value=[],d.value=[],l.value=0}async function F(a=1,r=500){const x=await K({dateFrom:u.value,dateTo:n.value,page:a,limit:r});return{data:x.data,meta:x.meta}}async function o(){let a=!1,r=1;for(t.value=[],l.value=0;!a&&t.value.length<c;)try{m.value=!0;const x=await F(r);l.value=x.meta.total,t.value.push(...x.data),r===x.meta.last_page&&(a=!0),r++}catch{T.error({message:"Не получилось загрузить данные о продажах"}),h()}finally{m.value=!1}l.value>=c&&T.warning({message:`Превышен лимит ${c} по количеству записей в одном запросе.`})}return L(()=>[u.value,n.value],()=>{u.value&&n.value?o():h()}),{dateFrom:u,dateTo:n,filteredSalesData:p,foundRecordsCount:l,salesData:t,isLoading:m,isMaxRecordCountExceeded:_,maxRecordsCount:c,selectedWarehouseNames:i,selectedRegionNames:d,warehouseNameOptions:e,regionNameOptions:y,getSalesData:o}}),V={class:"sales-filters"},W=I({__name:"SalesFilters",setup(m){const u=D(),{dateFrom:n,dateTo:l,salesData:c,selectedWarehouseNames:_,selectedRegionNames:t,warehouseNameOptions:p,regionNameOptions:i,isLoading:d}=S(u),e=v(()=>c.value.length===0||d.value),y=v(()=>n.value!==""||l.value!==""||_.value.length>0||t.value.length>0);function h(){n.value="",l.value="",_.value=[],t.value=[]}return(F,o)=>(w(),b("div",V,[f(C,{"date-text":s(n),"onUpdate:dateText":o[0]||(o[0]=a=>k(n)?n.value=a:null),disabled:s(d),title:"Дата с"},null,8,["date-text","disabled"]),f(C,{"date-text":s(l),"onUpdate:dateText":o[1]||(o[1]=a=>k(l)?l.value=a:null),disabled:s(d),title:"Дата до"},null,8,["date-text","disabled"]),f(N,{value:s(_),"onUpdate:value":o[2]||(o[2]=a=>k(_)?_.value=a:null),disabled:e.value,options:s(p),title:"Склад",width:300},null,8,["value","disabled","options"]),f(N,{value:s(t),"onUpdate:value":o[3]||(o[3]=a=>k(t)?t.value=a:null),disabled:e.value,options:s(i),title:"Регион",width:300},null,8,["value","disabled","options"]),f(s(O),{disabled:!y.value||s(d),type:"primary",onClick:h},{default:B(()=>[...o[4]||(o[4]=[E(" Очистить фильтры ",-1)])]),_:1},8,["disabled"])]))}}),q=R(W,[["__scopeId","data-v-cd5b75bb"]]),X={class:"sales-table"},G=I({__name:"SalesTable",setup(m){const u=D(),{filteredSalesData:n,isLoading:l,isMaxRecordCountExceeded:c,foundRecordsCount:_,salesData:t}=S(u),p=[{title:"ID продажи",dataIndex:"sale_id",key:"sale_id",width:150,fixed:"left"},{title:"NM ID",dataIndex:"nm_id",key:"nm_id",width:100,fixed:"left"},{title:"Номер заказа",dataIndex:"g_number",key:"g_number",width:150},{title:"ID дохода",dataIndex:"income_id",key:"income_id",width:100},{title:"ODID",dataIndex:"odid",key:"odid",width:100},{title:"Дата продажи",dataIndex:"date",key:"date",width:100},{title:"Артикул поставщика",dataIndex:"supplier_article",key:"supplier_article",width:150},{title:"Размер",dataIndex:"tech_size",key:"tech_size",width:150},{title:"Штрихкод",dataIndex:"barcode",key:"barcode",width:100},{title:"Итоговая цена",dataIndex:"total_price",key:"total_price",width:100,customRender:({value:e})=>e?parseFloat(e).toFixed(2):""},{title:"Скидка %",dataIndex:"discount_percent",key:"discount_percent",width:80},{title:"СПП %",dataIndex:"spp",key:"spp",width:80},{title:"К оплате",dataIndex:"for_pay",key:"for_pay",width:100,customRender:({value:e})=>e?parseFloat(e).toFixed(2):""},{title:"Финальная цена",dataIndex:"finished_price",key:"finished_price",width:100,customRender:({value:e})=>e?parseFloat(e).toFixed(2):""},{title:"Цена со скидкой",dataIndex:"price_with_disc",key:"price_with_disc",width:100,customRender:({value:e})=>e?parseFloat(e).toFixed(2):""},{title:"Скидка промокода",dataIndex:"promo_code_discount",key:"promo_code_discount",width:100},{title:"Склад",dataIndex:"warehouse_name",key:"warehouse_name",width:200},{title:"Регион",dataIndex:"region_name",key:"region_name",width:200},{title:"Область/Округ",dataIndex:"oblast_okrug_name",key:"oblast_okrug_name",width:250},{title:"Страна",dataIndex:"country_name",key:"country_name",width:150},{title:"Бренд",dataIndex:"brand",key:"brand",width:150},{title:"Предмет",dataIndex:"subject",key:"subject",width:150},{title:"Категория",dataIndex:"category",key:"category",width:150},{title:"Поставка",dataIndex:"is_supply",key:"is_supply",width:80,customRender:({value:e})=>e?"Да":"Нет"},{title:"Реализация",dataIndex:"is_realization",key:"is_realization",width:100,customRender:({value:e})=>e?"Да":"Нет"},{title:"Сторно",dataIndex:"is_storno",key:"is_storno",width:80,customRender:({value:e})=>e===null?"-":e?"Да":"Нет"},{title:"Последнее изменение",dataIndex:"last_change_date",key:"last_change_date",width:100}];function i(e){return`${e.sale_id}-${e.nm_id}-${e.income_id}-${e.odid}-${e.g_number}`}function d(e){return c.value?`Всего найдено ${_.value} строк за выбранный период, загружено ${t.value.length} строк. В таблице показано ${e} строк с учетом фильтрации.`:`Всего строк в таблице: ${e}`}return(e,y)=>(w(),b("div",X,[s(n).length>0?(w(),z(s(A),{key:0,dataSource:s(n),columns:p,loading:s(l),rowKey:h=>i(h),scroll:{x:"max-content"},size:"small",sticky:"",pagination:{pageSize:50,showTotal:h=>d(h),position:["topRight"],showSizeChanger:!1}},null,8,["dataSource","loading","rowKey","pagination"])):M("",!0)]))}}),H=R(G,[["__scopeId","data-v-88968545"]]),J={class:"sales-line-chart"},Q=I({__name:"SalesLineChart",setup(m){const u=D(),{filteredSalesData:n,dateFrom:l,dateTo:c}=S(u),_=v(()=>{const t=new Map;return n.value.forEach(p=>{const i=p.date,d=t.get(i)||0;t.set(i,d+parseFloat(p.total_price))}),Array.from(t.entries()).map(([p,i])=>({date:p,value:i}))});return(t,p)=>(w(),b("div",J,[s(n).length>0&&s(l)&&s(c)?(w(),z(j,{"start-date":s(l),"end-date":s(c),data:_.value,title:"Сумма продаж по датам",key:"line1"},null,8,["start-date","end-date","data"])):M("",!0)]))}}),Y={class:"sales-page"},Z=I({__name:"SalesPage",setup(m){return(u,n)=>(w(),b("div",Y,[f(q,{class:"sales-page__filters"}),f(Q,{class:"sales-page__chart"}),f(H,{class:"sales-page__table"})]))}}),se=R(Z,[["__scopeId","data-v-a3f80be2"]]);export{se as default};
